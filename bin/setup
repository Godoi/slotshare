#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$SCRIPT_DIR/.."

cd "$ROOT_DIR"

echo "ğŸ”§ Iniciando setup do Lab Modern PHP..."
echo

# 1. Build dos containers (se ainda nÃ£o existirem)
if ! docker-compose ps | grep -q "php-app.*Up"; then
  echo "ğŸ³ Subindo ambiente Docker..."
  docker-compose up -d --build
  sleep 3
fi

# 2. Verifica se Composer estÃ¡ funcionando
echo "ğŸ“¦ Verificando Composer..."
if ! docker-compose run --rm cli composer --version > /dev/null 2>&1; then
  echo "âŒ Falha ao acessar o Composer. Verifique o Dockerfile."
  exit 1
fi

# 3. Instala dependÃªncias (se composer.json existir)
if [ -f composer.json ]; then
  echo "ğŸ“¥ Instalando dependÃªncias (composer install)..."
  docker-compose run --rm cli composer install --prefer-dist --no-interaction
fi

# 4. Inicializa estrutura de testes (se nÃ£o existir)
if [ ! -d tests ] || [ ! -f tests/ExampleTest.php ]; then
  echo "ğŸ§ª Criando estrutura mÃ­nima de testes..."
  mkdir -p tests
  cat > tests/ExampleTest.php <<'EOF'
<?php
use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    public function testTrueIsTrue(): void
    {
        $this->assertTrue(true);
    }

    public function testXdebugAndPdoMysql(): void
    {
        $this->assertTrue(extension_loaded('xdebug'), 'Xdebug nÃ£o carregado');
        $this->assertTrue(extension_loaded('pdo_mysql'), 'pdo_mysql nÃ£o carregado');
    }
}
EOF
fi

# 5. Roda os testes com cobertura
echo "âœ… Rodando testes iniciais..."
docker-compose run --rm cli ./vendor/bin/phpunit --testdox

# 6. Gera relatÃ³rio de cobertura (opcional, comentado por padrÃ£o)
# echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
# mkdir -p build
# docker-compose run --rm cli ./vendor/bin/phpunit --coverage-html build/coverage

echo
echo "ğŸ‰ Setup concluÃ­do!"
echo
echo "PrÃ³ximos passos:"
echo "  ğŸ”— Acesse http://localhost:8080"
echo "  ğŸ§ª Execute testes: ./bin/test"
echo "  ğŸ Debug no VS Code: abra .vscode/launch.json e inicie uma sessÃ£o"